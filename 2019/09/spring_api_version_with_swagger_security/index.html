<!DOCTYPE html>
<html><head>
<title>Spring Boot 實作 API 版本控制</title>




<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="在 Spring Boot Web 專案實作動態 API 版本控制，並能兼容 Swagger 及 Spring Security">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">











<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-106499565-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


<link type="text/css" rel="stylesheet" href="https://idontwannarock.github.io/tech_blog/vendor/css/bootstrap.min.css">


  






<link rel="stylesheet" href="https://idontwannarock.github.io/tech_blog/scss/journal.min.3f72a5fc8f5b5dd732a4b476aced0eece2156958d9d414316494ddb10593ddf7.css" integrity="sha256-P3Kl/I9bXdcypLR2rO0O7OIVaVjZ1BQxZJTdsQWT3fc=" media="screen">



<link rel="stylesheet" href="https://idontwannarock.github.io/tech_blog/scss/dark-mode.min.f7c2efa7183435a6bd1842f91c541481c7a5137b5991629a870f24e4a516ad4b.css" integrity="sha256-98Lvpxg0Naa9GEL5HFQUgcelE3tZkWKahw8k5KUWrUs=" media="screen">


<script src="https://idontwannarock.github.io/tech_blog/vendor/js/loadCSS.js"></script>
<script>
  loadCSS("https://fonts.googleapis.com/css?family=Fira+Mono|Material+Icons");
</script>






  <script src="https://idontwannarock.github.io/tech_blog/js/toc.js"></script>














</head>
<body>
    	<div id="app"><div id="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="https://idontwannarock.github.io/tech_blog/">
    
        <div class="nav-title">
            Howard Tech Note
        </div>
        
        <div class="nav-subtitle">
            Share * Record * Program
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="https://idontwannarock.github.io/tech_blog/posts">
                Archive
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="https://idontwannarock.github.io/tech_blog/categories">
                Categories
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="https://idontwannarock.github.io/tech_blog/tags">
                Tags
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="https://idontwannarock.github.io/tech_blog/works">
                My Works
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="https://idontwannarock.github.io/tech_blog/about">
                About
            </a>
            
        
    </div>

    

    <div class="nav-footer">
        
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://amazingrise.net">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	This website by Howard Wang is licensed under a Creative Common Attribution-ShareAlike 4.0 International License.
	

    </div>
    
</div><div id="extraContainer" class="extra-container">
    
    
    <div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#api-%e7%89%88%e6%9c%ac%e6%8e%a7%e5%88%b6" onclick="onNavClick(`#api-版本控制-nav`)" id="api-版本控制-nav">
									API 版本控制
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#tech-stack" onclick="onNavClick(`#tech-stack-nav`)" id="tech-stack-nav">
									Tech Stack
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%b8%b8%e8%a6%8b%e4%bd%9c%e6%b3%95%e5%8f%8a%e6%95%b4%e5%90%88%e5%95%8f%e9%a1%8c" onclick="onNavClick(`#常見作法及整合問題-nav`)" id="常見作法及整合問題-nav">
									常見作法及整合問題
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e5%85%bc%e5%ae%b9-swagger" onclick="onNavClick(`#兼容-swagger-nav`)" id="兼容-swagger-nav">
									兼容 Swagger
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#spring-security-%e8%a8%ad%e5%ae%9a" onclick="onNavClick(`#spring-security-設定-nav`)" id="spring-security-設定-nav">
									Spring Security 設定
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#spring-boot-auto-configuration-%e5%a4%b1%e6%95%88%e5%95%8f%e9%a1%8c" onclick="onNavClick(`#spring-boot-auto-configuration-失效問題-nav`)" id="spring-boot-auto-configuration-失效問題-nav">
									Spring Boot auto configuration 失效問題
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
    
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a type="button" class="pagination-action" id="darkModeToggleButton">
            <span class="material-icons pagination-action-icon" id="darkModeToggleIcon">
                dark_mode
            </span>
        </a>
        
        
    </div>
</div>
<div class="single-column-drawer-container" id="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="https://idontwannarock.github.io/tech_blog/posts">
                    Archive
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="https://idontwannarock.github.io/tech_blog/categories">
                    Categories
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="https://idontwannarock.github.io/tech_blog/tags">
                    Tags
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="https://idontwannarock.github.io/tech_blog/works">
                    My Works
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="https://idontwannarock.github.io/tech_blog/about">
                    About
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#api-%e7%89%88%e6%9c%ac%e6%8e%a7%e5%88%b6" onclick="onNavClick(`#api-版本控制-nav`)" id="api-版本控制-nav">
									API 版本控制
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#tech-stack" onclick="onNavClick(`#tech-stack-nav`)" id="tech-stack-nav">
									Tech Stack
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%b8%b8%e8%a6%8b%e4%bd%9c%e6%b3%95%e5%8f%8a%e6%95%b4%e5%90%88%e5%95%8f%e9%a1%8c" onclick="onNavClick(`#常見作法及整合問題-nav`)" id="常見作法及整合問題-nav">
									常見作法及整合問題
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e5%85%bc%e5%ae%b9-swagger" onclick="onNavClick(`#兼容-swagger-nav`)" id="兼容-swagger-nav">
									兼容 Swagger
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#spring-security-%e8%a8%ad%e5%ae%9a" onclick="onNavClick(`#spring-security-設定-nav`)" id="spring-security-設定-nav">
									Spring Security 設定
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#spring-boot-auto-configuration-%e5%a4%b1%e6%95%88%e5%95%8f%e9%a1%8c" onclick="onNavClick(`#spring-boot-auto-configuration-失效問題-nav`)" id="spring-boot-auto-configuration-失效問題-nav">
									Spring Boot auto configuration 失效問題
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div id="drawer-mask" v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav id="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div id="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a id="navTitle" class="navbar-brand" href="https://idontwannarock.github.io/tech_blog/">
            Howard Tech Note
        </a>
        
        <button type="button" class="nav-darkmode-toggle" id="darkModeToggleButton2">
            <i class="material-icons" id="darkModeToggleIcon2">
                dark_mode
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" id="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="https://idontwannarock.github.io/tech_blog/">
        <div class="single-column-header-title">Howard Tech Note</div>
        
        <div class="single-column-header-subtitle">Share * Record * Program</div>
        

    </a>
</div>

            <div id="content">
                <div id="streamContainer" class="stream-container">

    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            
                
            

            <div class="post-head-wrapper"
                
                    
                    
                    style="background-image: url('https://res.cloudinary.com/dcvgho2zc/image/upload/v1568911044/icon-spring-framework_lskrrp.svg')"
                    
                
            >
                <div class="post-title">
                    Spring Boot 實作 API 版本控制
                    
                    <div class="post-subtitle">
                        在 Spring Boot Web 專案實作動態 API 版本控制，並能兼容 Swagger 及 Spring Security
                    </div>
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2019-09-19 15:53
                        </time>
                        

                        
                            <i class="material-icons" style="">folder</i>
                                <a href="https://idontwannarock.github.io/tech_blog/categories/application">application</a>
                                &nbsp;
                        

                        
                            <i class="material-icons" style="">label</i>
                            
                                <a href="https://idontwannarock.github.io/tech_blog/tags/java">java</a>
                                &nbsp;
                            
                                <a href="https://idontwannarock.github.io/tech_blog/tags/spring-boot">spring-boot</a>
                                &nbsp;
                            
                                <a href="https://idontwannarock.github.io/tech_blog/tags/spring-security">spring-security</a>
                                &nbsp;
                            
                                <a href="https://idontwannarock.github.io/tech_blog/tags/swagger">swagger</a>
                                &nbsp;
                            
                                <a href="https://idontwannarock.github.io/tech_blog/tags/api-versioning">api-versioning</a>
                                &nbsp;
                            
                        
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                
                <div class="post-body" v-pre>
                
                    <p>本文目的是為了探討在 Spring Boot Web 專案中，實作 API 版本控制，並兼容 Swagger 及 Spring Security 的解決方式</p>
<p>需要有 Spring Boot、Spring MVC、Spring Security 及 Swagger 的基礎概念會比較好理解</p>
<h1 id="api-版本控制">API 版本控制</h1>
<p>常見的 API 版本控制方式有三種: URI, header, content-type</p>
<p>考量到 RESTful API 其中的一個好處是方便快取，使用 header 跟 content-type 的方式則可能無法正確的快取以及達成 idempotent，所以我個人採用的是在 URI 中加入版本號的方式</p>
<p>再來因為有時候面對的專案有數量眾多的 handler，導致每次修改版本號都要手動修改每一支 handler 對應的 uri，這樣既麻煩又不潮，所以一定要研究一下怎麼在 Spring Boot 專案中利用註解的方式自動幫 handler 對應的 uri 自動插入版本號</p>
<h1 id="tech-stack">Tech Stack</h1>
<p>專案採用的是 Spring Boot 2.0 架構，Java 1.8 版本</p>
<p>有關 Maven 依賴如下:</p>
<ul>
<li>org.springframework.boot:spring-boot-starter-web:2.1.x</li>
<li>org.springframework.boot:spring-boot-starter-security:2.1.x</li>
<li>io.springfox:springfox-swagger2:2.9.2</li>
<li>io.springfox:springfox-swagger-ui:2.9.2</li>
</ul>
<p>這邊強調要採用 Spring Boot 主要是因為想要利用 Spring Boot auto configuration 的功能，也因為想要利用這個功能，所以過程才會這麼曲折&hellip;</p>
<h1 id="常見作法及整合問題">常見作法及整合問題</h1>
<p>網路上 API 版本控制的文章的做法都雷同</p>
<p>通常都是先建立自訂 <code>ApiVersion</code> 註解，裡面有版本號屬性，可以是 <code>int</code> 也可以是字串，通常都會有預設值，然後容許加註在類別或方法</p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5bc4bf">import</span> <span style="color:#fec418">java.lang.annotation.*</span><span style="color:#5bc4bf">;</span>

<span style="color:#5bc4bf">@Target</span><span style="color:#5bc4bf">({</span>ElementType<span style="color:#5bc4bf">.</span><span style="color:#06b6ef">TYPE</span><span style="color:#5bc4bf">,</span> ElementType<span style="color:#5bc4bf">.</span><span style="color:#06b6ef">METHOD</span><span style="color:#5bc4bf">})</span>
<span style="color:#5bc4bf">@Retention</span><span style="color:#5bc4bf">(</span>RetentionPolicy<span style="color:#5bc4bf">.</span><span style="color:#06b6ef">RUNTIME</span><span style="color:#5bc4bf">)</span>
<span style="color:#815ba4">public</span> <span style="color:#5bc4bf">@interface</span> ApiVersion <span style="color:#5bc4bf">{</span>

    <span style="color:#fec418">int</span> <span style="color:#06b6ef">value</span><span style="color:#5bc4bf">()</span> <span style="color:#815ba4">default</span> 1<span style="color:#5bc4bf">;</span>
<span style="color:#5bc4bf">}</span>
</code></pre></div><p>再來寫 <code>ApiVersionCondition</code> 實作 <code>RequestCondition</code> 介面來判斷 request 跟 handler mapping 的條件</p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5bc4bf">import</span> <span style="color:#fec418">org.springframework.web.servlet.mvc.condition.RequestCondition</span><span style="color:#5bc4bf">;</span>

<span style="color:#5bc4bf">import</span> <span style="color:#fec418">javax.servlet.http.HttpServletRequest</span><span style="color:#5bc4bf">;</span>
<span style="color:#5bc4bf">import</span> <span style="color:#fec418">java.util.regex.Matcher</span><span style="color:#5bc4bf">;</span>
<span style="color:#5bc4bf">import</span> <span style="color:#fec418">java.util.regex.Pattern</span><span style="color:#5bc4bf">;</span>

<span style="color:#815ba4">public</span> <span style="color:#815ba4">class</span> <span style="color:#fec418">ApiVersionCondition</span> <span style="color:#815ba4">implements</span> RequestCondition<span style="color:#5bc4bf">&lt;</span>ApiVersionCondition<span style="color:#5bc4bf">&gt;</span> <span style="color:#5bc4bf">{</span>

    <span style="color:#815ba4">private</span> <span style="color:#fec418">int</span> apiVersion<span style="color:#5bc4bf">;</span>

    <span style="color:#815ba4">private</span> <span style="color:#815ba4">final</span> <span style="color:#815ba4">static</span> Pattern VERSION_PREFIX_PATTERN <span style="color:#5bc4bf">=</span> Pattern<span style="color:#5bc4bf">.</span><span style="color:#06b6ef">compile</span><span style="color:#5bc4bf">(</span><span style="color:#48b685">&#34;/v(\\d+)/&#34;</span><span style="color:#5bc4bf">);</span>

    <span style="color:#815ba4">public</span> <span style="color:#06b6ef">ApiVersionCondition</span><span style="color:#5bc4bf">(</span><span style="color:#fec418">int</span> apiVersion<span style="color:#5bc4bf">)</span> <span style="color:#5bc4bf">{</span>
        <span style="color:#815ba4">this</span><span style="color:#5bc4bf">.</span><span style="color:#06b6ef">apiVersion</span> <span style="color:#5bc4bf">=</span> apiVersion<span style="color:#5bc4bf">;</span>
    <span style="color:#5bc4bf">}</span>

    <span style="color:#5bc4bf">@Override</span>
    <span style="color:#815ba4">public</span> ApiVersionCondition <span style="color:#06b6ef">combine</span><span style="color:#5bc4bf">(</span>ApiVersionCondition other<span style="color:#5bc4bf">)</span> <span style="color:#5bc4bf">{</span>
        <span style="color:#815ba4">return</span> <span style="color:#815ba4">new</span> ApiVersionCondition<span style="color:#5bc4bf">(</span>other<span style="color:#5bc4bf">.</span><span style="color:#06b6ef">getApiVersion</span><span style="color:#5bc4bf">());</span>
    <span style="color:#5bc4bf">}</span>

    <span style="color:#5bc4bf">@Override</span>
    <span style="color:#815ba4">public</span> ApiVersionCondition <span style="color:#06b6ef">getMatchingCondition</span><span style="color:#5bc4bf">(</span>HttpServletRequest request<span style="color:#5bc4bf">)</span> <span style="color:#5bc4bf">{</span>
        Matcher m <span style="color:#5bc4bf">=</span> VERSION_PREFIX_PATTERN<span style="color:#5bc4bf">.</span><span style="color:#06b6ef">matcher</span><span style="color:#5bc4bf">(</span>request<span style="color:#5bc4bf">.</span><span style="color:#06b6ef">getRequestURI</span><span style="color:#5bc4bf">());</span>
        <span style="color:#815ba4">if</span> <span style="color:#5bc4bf">(</span>m<span style="color:#5bc4bf">.</span><span style="color:#06b6ef">find</span><span style="color:#5bc4bf">())</span> <span style="color:#5bc4bf">{</span>
            <span style="color:#fec418">int</span> version <span style="color:#5bc4bf">=</span> Integer<span style="color:#5bc4bf">.</span><span style="color:#06b6ef">parseInt</span><span style="color:#5bc4bf">(</span>m<span style="color:#5bc4bf">.</span><span style="color:#06b6ef">group</span><span style="color:#5bc4bf">(</span>1<span style="color:#5bc4bf">));</span>
            <span style="color:#815ba4">if</span> <span style="color:#5bc4bf">(</span>version <span style="color:#5bc4bf">&gt;=</span> getApiVersion<span style="color:#5bc4bf">())</span> <span style="color:#5bc4bf">{</span>
                <span style="color:#815ba4">return</span> <span style="color:#815ba4">this</span><span style="color:#5bc4bf">;</span>
            <span style="color:#5bc4bf">}</span>
        <span style="color:#5bc4bf">}</span>
        <span style="color:#815ba4">return</span> <span style="color:#815ba4">null</span><span style="color:#5bc4bf">;</span>
    <span style="color:#5bc4bf">}</span>

    <span style="color:#5bc4bf">@Override</span>
    <span style="color:#815ba4">public</span> <span style="color:#fec418">int</span> <span style="color:#06b6ef">compareTo</span><span style="color:#5bc4bf">(</span>ApiVersionCondition other<span style="color:#5bc4bf">,</span> HttpServletRequest request<span style="color:#5bc4bf">)</span> <span style="color:#5bc4bf">{</span>
        <span style="color:#815ba4">return</span> other<span style="color:#5bc4bf">.</span><span style="color:#06b6ef">getApiVersion</span><span style="color:#5bc4bf">()</span> <span style="color:#5bc4bf">-</span> getApiVersion<span style="color:#5bc4bf">();</span>
    <span style="color:#5bc4bf">}</span>

    <span style="color:#815ba4">public</span> <span style="color:#fec418">int</span> <span style="color:#06b6ef">getApiVersion</span><span style="color:#5bc4bf">()</span> <span style="color:#5bc4bf">{</span>
        <span style="color:#815ba4">return</span> apiVersion<span style="color:#5bc4bf">;</span>
    <span style="color:#5bc4bf">}</span>

    <span style="color:#815ba4">public</span> <span style="color:#fec418">void</span> <span style="color:#06b6ef">setApiVersion</span><span style="color:#5bc4bf">(</span><span style="color:#fec418">int</span> apiVersion<span style="color:#5bc4bf">)</span> <span style="color:#5bc4bf">{</span>
        <span style="color:#815ba4">this</span><span style="color:#5bc4bf">.</span><span style="color:#06b6ef">apiVersion</span> <span style="color:#5bc4bf">=</span> apiVersion<span style="color:#5bc4bf">;</span>
    <span style="color:#5bc4bf">}</span>
<span style="color:#5bc4bf">}</span>
</code></pre></div><p>接著寫自訂 <code>CustomRequestMappingHandlerMapping</code> 類別，繼承 <code>RequestMappingHandlerMapping</code> 並 override <code>getCustomTypeCondition(Class&lt;?&gt; handlerType)</code> 跟 <code>getCustomMethodCondition(Method method)</code> 這兩個方法，以分別取得類別跟方法上的 <code>ApiVersion</code> 註解，並據此建立 <code>ApiVersionCondition</code> 給 Spring MVC 做 request mapping 時調用</p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5bc4bf">import</span> <span style="color:#fec418">org.springframework.core.annotation.AnnotationUtils</span><span style="color:#5bc4bf">;</span>
<span style="color:#5bc4bf">import</span> <span style="color:#fec418">org.springframework.web.servlet.mvc.condition.*</span><span style="color:#5bc4bf">;</span>
<span style="color:#5bc4bf">import</span> <span style="color:#fec418">org.springframework.web.servlet.mvc.method.RequestMappingInfo</span><span style="color:#5bc4bf">;</span>
<span style="color:#5bc4bf">import</span> <span style="color:#fec418">org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping</span><span style="color:#5bc4bf">;</span>

<span style="color:#5bc4bf">import</span> <span style="color:#fec418">java.lang.reflect.Method</span><span style="color:#5bc4bf">;</span>

<span style="color:#815ba4">public</span> <span style="color:#815ba4">class</span> <span style="color:#fec418">ApiVersionHandlerMapping</span> <span style="color:#815ba4">extends</span> RequestMappingHandlerMapping <span style="color:#5bc4bf">{</span>

    <span style="color:#5bc4bf">@Override</span>
    <span style="color:#815ba4">public</span> RequestCondition<span style="color:#5bc4bf">&lt;?&gt;</span> getCustomTypeCondition<span style="color:#5bc4bf">(</span>Class<span style="color:#5bc4bf">&lt;?&gt;</span> handlerType<span style="color:#5bc4bf">)</span> <span style="color:#5bc4bf">{</span>
        ApiVersion apiVersion <span style="color:#5bc4bf">=</span> AnnotationUtils<span style="color:#5bc4bf">.</span><span style="color:#06b6ef">findAnnotation</span><span style="color:#5bc4bf">(</span>handlerType<span style="color:#5bc4bf">,</span> ApiVersion<span style="color:#5bc4bf">.</span><span style="color:#06b6ef">class</span><span style="color:#5bc4bf">);</span>
        <span style="color:#815ba4">return</span> createRequestCondition<span style="color:#5bc4bf">(</span>apiVersion<span style="color:#5bc4bf">);</span>
    <span style="color:#5bc4bf">}</span>

    <span style="color:#5bc4bf">@Override</span>
    <span style="color:#815ba4">public</span> RequestCondition<span style="color:#5bc4bf">&lt;?&gt;</span> getCustomMethodCondition<span style="color:#5bc4bf">(</span>Method method<span style="color:#5bc4bf">)</span> <span style="color:#5bc4bf">{</span>
        ApiVersion apiVersion <span style="color:#5bc4bf">=</span> AnnotationUtils<span style="color:#5bc4bf">.</span><span style="color:#06b6ef">findAnnotation</span><span style="color:#5bc4bf">(</span>method<span style="color:#5bc4bf">,</span> ApiVersion<span style="color:#5bc4bf">.</span><span style="color:#06b6ef">class</span><span style="color:#5bc4bf">);</span>
        <span style="color:#815ba4">return</span> createRequestCondition<span style="color:#5bc4bf">(</span>apiVersion<span style="color:#5bc4bf">);</span>
    <span style="color:#5bc4bf">}</span>

    <span style="color:#815ba4">private</span> RequestCondition<span style="color:#5bc4bf">&lt;</span>ApiVersionCondition<span style="color:#5bc4bf">&gt;</span> <span style="color:#06b6ef">createRequestCondition</span><span style="color:#5bc4bf">(</span>ApiVersion apiVersion<span style="color:#5bc4bf">)</span> <span style="color:#5bc4bf">{</span>
        <span style="color:#815ba4">if</span> <span style="color:#5bc4bf">(</span>apiVersion <span style="color:#5bc4bf">==</span> <span style="color:#815ba4">null</span> <span style="color:#5bc4bf">||</span> apiVersion<span style="color:#5bc4bf">.</span><span style="color:#06b6ef">value</span><span style="color:#5bc4bf">()</span> <span style="color:#5bc4bf">&lt;</span> 1<span style="color:#5bc4bf">)</span> <span style="color:#5bc4bf">{</span>
            <span style="color:#815ba4">return</span> <span style="color:#815ba4">null</span><span style="color:#5bc4bf">;</span>
        <span style="color:#5bc4bf">}</span>
        <span style="color:#815ba4">return</span> <span style="color:#815ba4">new</span> ApiVersionCondition<span style="color:#5bc4bf">(</span>apiVersion<span style="color:#5bc4bf">.</span><span style="color:#06b6ef">value</span><span style="color:#5bc4bf">());</span>
    <span style="color:#5bc4bf">}</span>
<span style="color:#5bc4bf">}</span>
</code></pre></div><p>最後再建立一個設定類別繼承 <code>WebMvcConfigurationSupport</code> 類別並 override <code>requestMappingHandlerMapping()</code> 方法來提供自訂的 <code>CustomRequestMappingHandlerMapping</code></p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5bc4bf">import</span> <span style="color:#fec418">org.springframework.context.annotation.Configuration</span><span style="color:#5bc4bf">;</span>
<span style="color:#5bc4bf">import</span> <span style="color:#fec418">org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport</span><span style="color:#5bc4bf">;</span>
<span style="color:#5bc4bf">import</span> <span style="color:#fec418">org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping</span><span style="color:#5bc4bf">;</span>

<span style="color:#5bc4bf">@Configuration</span>
<span style="color:#815ba4">public</span> <span style="color:#815ba4">class</span> <span style="color:#fec418">WebMvcConfig</span> <span style="color:#815ba4">extends</span> WebMvcConfigurationSupport <span style="color:#5bc4bf">{</span>

    <span style="color:#5bc4bf">@Override</span>
    <span style="color:#815ba4">public</span> RequestMappingHandlerMapping <span style="color:#06b6ef">requestMappingHandlerMapping</span><span style="color:#5bc4bf">()</span> <span style="color:#5bc4bf">{</span>
        ApiVersionHandlerMapping handlerMapping <span style="color:#5bc4bf">=</span> <span style="color:#815ba4">new</span> ApiVersionHandlerMapping<span style="color:#5bc4bf">();</span>
        handlerMapping<span style="color:#5bc4bf">.</span><span style="color:#06b6ef">setOrder</span><span style="color:#5bc4bf">(</span>0<span style="color:#5bc4bf">);</span>
        handlerMapping<span style="color:#5bc4bf">.</span><span style="color:#06b6ef">setInterceptors</span><span style="color:#5bc4bf">(</span>getInterceptors<span style="color:#5bc4bf">());</span>
        <span style="color:#815ba4">return</span> handlerMapping<span style="color:#5bc4bf">;</span>
    <span style="color:#5bc4bf">}</span>
<span style="color:#5bc4bf">}</span>
</code></pre></div><p>這樣就可以在 controller 開心地加上 <code>ApiVersion</code> 註解啦</p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5bc4bf">import</span> <span style="color:#fec418">org.springframework.http.ResponseEntity</span><span style="color:#5bc4bf">;</span>
<span style="color:#5bc4bf">import</span> <span style="color:#fec418">org.springframework.web.bind.annotation.*</span><span style="color:#5bc4bf">;</span>

<span style="color:#5bc4bf">@ApiVersion</span>
<span style="color:#5bc4bf">@RequestMapping</span><span style="color:#5bc4bf">(</span><span style="color:#48b685">&#34;home&#34;</span><span style="color:#5bc4bf">)</span>
<span style="color:#5bc4bf">@RestController</span>
<span style="color:#815ba4">public</span> <span style="color:#815ba4">class</span> <span style="color:#fec418">HomeController</span> <span style="color:#5bc4bf">{</span>

    <span style="color:#5bc4bf">@GetMapping</span><span style="color:#5bc4bf">(</span><span style="color:#48b685">&#34;hello&#34;</span><span style="color:#5bc4bf">)</span>
    <span style="color:#815ba4">public</span> ResponseEntity<span style="color:#5bc4bf">&lt;?&gt;</span> hello<span style="color:#5bc4bf">()</span> <span style="color:#5bc4bf">{</span>
        <span style="color:#815ba4">return</span> ResponseEntity<span style="color:#5bc4bf">.</span><span style="color:#06b6ef">ok</span><span style="color:#5bc4bf">(</span><span style="color:#48b685">&#34;Hello world!&#34;</span><span style="color:#5bc4bf">);</span>
    <span style="color:#5bc4bf">}</span>

    <span style="color:#5bc4bf">@ApiVersion</span><span style="color:#5bc4bf">(</span>2<span style="color:#5bc4bf">)</span>
    <span style="color:#5bc4bf">@GetMapping</span><span style="color:#5bc4bf">(</span><span style="color:#48b685">&#34;hello&#34;</span><span style="color:#5bc4bf">)</span>
    <span style="color:#815ba4">public</span> ResponseEntity<span style="color:#5bc4bf">&lt;?&gt;</span> helloV2<span style="color:#5bc4bf">()</span> <span style="color:#5bc4bf">{</span>
        <span style="color:#815ba4">return</span> ResponseEntity<span style="color:#5bc4bf">.</span><span style="color:#06b6ef">ok</span><span style="color:#5bc4bf">(</span><span style="color:#48b685">&#34;Nice to meet you!&#34;</span><span style="color:#5bc4bf">);</span>
    <span style="color:#5bc4bf">}</span>
<span style="color:#5bc4bf">}</span>
</code></pre></div><p><strong>BUT，人生就是這個 BUT</strong></p>
<p>當你要兼容 Swagger 的時候，事情就沒這麼簡單惹，你會發現馬德，swagger-ui.html 開起來打 API 怎麼都沒有版本號？！</p>
<p>其實到這邊本文才要正式開始，否則你隨便 google 都是這樣的內容，我還寫個毛</p>
<h2 id="兼容-swagger">兼容 Swagger</h2>
<p>首先，要整合 Swagger 有個問題，Swagger 會讀取 handler 的 <code>RequestMappingInfo</code> 來產生文件；但前面的作法其實是 request 進來後，利用 <code>RequestCondition</code> 來邏輯上將 request 導向 handler，實際上的 path 沒有改變，所以 Swagger 當然讀不到正確的 uri 來產生文件</p>
<p>於是就有了另外一種做法</p>
<p>在前面寫好的 <code>CustomRequestMappingHandlerMapping</code> 中，另外再 override <code>getMappingForMethod(Method method, Class&lt;?&gt; handlerType)</code> 方法去調整 <code>RequestMappingInfo</code></p>
<p>這部分的作法其實要看狀況，但網路上有些範例不知道是不是比較早期的文章，還有用到 <code>Proxy</code> 來操作的寫法，我是覺得有點不必要</p>
<p>Spring MVC 其實在 <code>RequestMappingInfo</code> 裡面已經有很靈活的 constructor 可以做這方面的設定，並且提供方法可以跟原有的 <code>RequestMappingInfo</code> 做合併</p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5bc4bf">@Override</span>
<span style="color:#815ba4">public</span> RequestMappingInfo <span style="color:#06b6ef">getMappingForMethod</span><span style="color:#5bc4bf">(</span>Method method<span style="color:#5bc4bf">,</span> Class<span style="color:#5bc4bf">&lt;?&gt;</span> handlerType<span style="color:#5bc4bf">)</span> <span style="color:#5bc4bf">{</span>
    RequestMappingInfo info <span style="color:#5bc4bf">=</span> <span style="color:#815ba4">super</span><span style="color:#5bc4bf">.</span><span style="color:#06b6ef">getMappingForMethod</span><span style="color:#5bc4bf">(</span>method<span style="color:#5bc4bf">,</span> handlerType<span style="color:#5bc4bf">);</span>
    <span style="color:#815ba4">if</span> <span style="color:#5bc4bf">(</span>info <span style="color:#5bc4bf">==</span> <span style="color:#815ba4">null</span><span style="color:#5bc4bf">)</span> <span style="color:#815ba4">return</span> <span style="color:#815ba4">null</span><span style="color:#5bc4bf">;</span>

    ApiVersion methodAnnotation <span style="color:#5bc4bf">=</span> AnnotationUtils<span style="color:#5bc4bf">.</span><span style="color:#06b6ef">findAnnotation</span><span style="color:#5bc4bf">(</span>method<span style="color:#5bc4bf">,</span> ApiVersion<span style="color:#5bc4bf">.</span><span style="color:#06b6ef">class</span><span style="color:#5bc4bf">);</span>
    <span style="color:#815ba4">if</span> <span style="color:#5bc4bf">(</span>methodAnnotation <span style="color:#5bc4bf">!=</span> <span style="color:#815ba4">null</span><span style="color:#5bc4bf">)</span> <span style="color:#5bc4bf">{</span>
        RequestCondition<span style="color:#5bc4bf">&lt;?&gt;</span> methodCondition <span style="color:#5bc4bf">=</span> getCustomMethodCondition<span style="color:#5bc4bf">(</span>method<span style="color:#5bc4bf">);</span>
        info <span style="color:#5bc4bf">=</span> createApiVersionInfo<span style="color:#5bc4bf">(</span>methodAnnotation<span style="color:#5bc4bf">,</span> methodCondition<span style="color:#5bc4bf">).</span><span style="color:#06b6ef">combine</span><span style="color:#5bc4bf">(</span>info<span style="color:#5bc4bf">);</span>
    <span style="color:#5bc4bf">}</span> <span style="color:#815ba4">else</span> <span style="color:#5bc4bf">{</span>
        ApiVersion typeAnnotation <span style="color:#5bc4bf">=</span> AnnotationUtils<span style="color:#5bc4bf">.</span><span style="color:#06b6ef">findAnnotation</span><span style="color:#5bc4bf">(</span>handlerType<span style="color:#5bc4bf">,</span> ApiVersion<span style="color:#5bc4bf">.</span><span style="color:#06b6ef">class</span><span style="color:#5bc4bf">);</span>
        <span style="color:#815ba4">if</span> <span style="color:#5bc4bf">(</span>typeAnnotation <span style="color:#5bc4bf">!=</span> <span style="color:#815ba4">null</span><span style="color:#5bc4bf">)</span> <span style="color:#5bc4bf">{</span>
            RequestCondition<span style="color:#5bc4bf">&lt;?&gt;</span> typeCondition <span style="color:#5bc4bf">=</span> getCustomTypeCondition<span style="color:#5bc4bf">(</span>handlerType<span style="color:#5bc4bf">);</span>
            info <span style="color:#5bc4bf">=</span> createApiVersionInfo<span style="color:#5bc4bf">(</span>typeAnnotation<span style="color:#5bc4bf">,</span> typeCondition<span style="color:#5bc4bf">).</span><span style="color:#06b6ef">combine</span><span style="color:#5bc4bf">(</span>info<span style="color:#5bc4bf">);</span>
        <span style="color:#5bc4bf">}</span>
    <span style="color:#5bc4bf">}</span>
    <span style="color:#815ba4">return</span> info<span style="color:#5bc4bf">;</span>
<span style="color:#5bc4bf">}</span>

<span style="color:#815ba4">private</span> RequestMappingInfo <span style="color:#06b6ef">createApiVersionInfo</span><span style="color:#5bc4bf">(</span>ApiVersion annotation<span style="color:#5bc4bf">,</span> RequestCondition<span style="color:#5bc4bf">&lt;?&gt;</span> customCondition<span style="color:#5bc4bf">)</span> <span style="color:#5bc4bf">{</span>
    <span style="color:#815ba4">return</span> <span style="color:#815ba4">new</span> RequestMappingInfo<span style="color:#5bc4bf">(</span>
            <span style="color:#815ba4">new</span> PatternsRequestCondition<span style="color:#5bc4bf">(</span><span style="color:#48b685">&#34;v&#34;</span><span style="color:#5bc4bf">.</span><span style="color:#06b6ef">concat</span><span style="color:#5bc4bf">(</span>String<span style="color:#5bc4bf">.</span><span style="color:#06b6ef">valueOf</span><span style="color:#5bc4bf">(</span>annotation<span style="color:#5bc4bf">.</span><span style="color:#06b6ef">value</span><span style="color:#5bc4bf">()))),</span>
            <span style="color:#815ba4">new</span> RequestMethodsRequestCondition<span style="color:#5bc4bf">(),</span>
            <span style="color:#815ba4">new</span> ParamsRequestCondition<span style="color:#5bc4bf">(),</span>
            <span style="color:#815ba4">new</span> HeadersRequestCondition<span style="color:#5bc4bf">(),</span>
            <span style="color:#815ba4">new</span> ConsumesRequestCondition<span style="color:#5bc4bf">(),</span>
            <span style="color:#815ba4">new</span> ProducesRequestCondition<span style="color:#5bc4bf">(),</span>
            customCondition<span style="color:#5bc4bf">);</span>
<span style="color:#5bc4bf">}</span>
</code></pre></div><p>這時候再打開 swagger-ui.html，就會覺得空氣是多麼清新，世界是多麼美好</p>
<h2 id="spring-security-設定">Spring Security 設定</h2>
<p>當然，因為現在很多 handler 的 uri 不一樣了，設定 Spring Security 哪些請求要擋哪些不用的部分當然也要改</p>
<p>最簡單就是在繼承 <code>WebSecurityConfigurerAdapter</code> 的設定類別那邊手動加版本號，我自己是採用這種方式，因為考慮 Spring Security 本來就是安全考量要盡量嚴謹，會開放不用做驗證的部分應該本來就很少，所以手動修改這部分我覺得可以接受</p>
<p>另外提醒一下如果要使用 swagger-ui.html，要將相關的靜態資源開放，建議可以做在繼承 <code>WebSecurityConfigurerAdapter</code> 的設定類別的 <code>configure(HttpSecurity httpSecurity)</code> 方法中，可以省下另外註冊 resource 的功夫</p>
<h2 id="spring-boot-auto-configuration-失效問題">Spring Boot auto configuration 失效問題</h2>
<p>其實這樣寫完還有一個問題，萬一我有其他自訂部分有用到從 <code>WebMvcConfigurer</code> 繼承來的方法，你會發現馬德，全都失效了</p>
<p>崩╰(〒皿〒)╯潰</p>
<p>這是因為前面繼承到萬惡的 <code>WebMvcConfigurationSupport</code> 了</p>
<p>Spring Boot 的原則是 convention over configuration，所以它有很多自動設定，關於 Spring MVC 的部分就是 <code>WebMvcAutoConfiguration</code> 在管</p>
<p>而不論是 <code>@EnableWebMvc</code> 註解或直接繼承 <code>WebMvcConfigurationSupport</code> 都會停用 <code>WebMvcAutoConfiguration</code>，Spring Boot 就會改用你 <code>@EnableWebMvc</code> 註解的類別或直接繼承 <code>WebMvcConfigurationSupport</code> 的類別來做設定；如果剛好你需要的自訂部分在這裡沒有想辦法設定進去，那你繼承 <code>WebMvcConfigurer</code> 的設定就白寫了</p>
<p>解決的關鍵點就是 <code>WebMvcRegistrations</code> 介面，看是要實作介面還是匿名類別的 <code>@Bean</code> 給 Spring Boot 都可以</p>
<p>我是寫在繼承 <code>WebMvcConfigurer</code> 的設定類別裡面，讓 Sring MVC 相關設定集中</p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5bc4bf">import</span> <span style="color:#fec418">org.springframework.boot.autoconfigure.web.servlet.WebMvcRegistrations</span><span style="color:#5bc4bf">;</span>
<span style="color:#5bc4bf">import</span> <span style="color:#fec418">org.springframework.context.annotation.Bean</span><span style="color:#5bc4bf">;</span>
<span style="color:#5bc4bf">import</span> <span style="color:#fec418">org.springframework.context.annotation.Configuration</span><span style="color:#5bc4bf">;</span>
<span style="color:#5bc4bf">import</span> <span style="color:#fec418">org.springframework.web.servlet.config.annotation.WebMvcConfigurer</span><span style="color:#5bc4bf">;</span>
<span style="color:#5bc4bf">import</span> <span style="color:#fec418">org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping</span><span style="color:#5bc4bf">;</span>

<span style="color:#5bc4bf">@Configuration</span>
<span style="color:#815ba4">public</span> <span style="color:#815ba4">class</span> <span style="color:#fec418">CustomWebMvcConfigurer</span> <span style="color:#815ba4">implements</span> WebMvcConfigurer <span style="color:#5bc4bf">{</span>

    <span style="color:#5bc4bf">@Bean</span>
    <span style="color:#815ba4">public</span> WebMvcRegistrations <span style="color:#06b6ef">webMvcRegistrationsRequestMappingHandlerMapping</span><span style="color:#5bc4bf">()</span> <span style="color:#5bc4bf">{</span>
        <span style="color:#815ba4">return</span> <span style="color:#815ba4">new</span> WebMvcRegistrations<span style="color:#5bc4bf">()</span> <span style="color:#5bc4bf">{</span>
            
            <span style="color:#5bc4bf">@Override</span>
            <span style="color:#815ba4">public</span> RequestMappingHandlerMapping <span style="color:#06b6ef">getRequestMappingHandlerMapping</span><span style="color:#5bc4bf">()</span> <span style="color:#5bc4bf">{</span>
                <span style="color:#815ba4">return</span> <span style="color:#815ba4">new</span> ApiVersionHandlerMapping<span style="color:#5bc4bf">();</span>
            <span style="color:#5bc4bf">}</span>
        <span style="color:#5bc4bf">};</span>
    <span style="color:#5bc4bf">}</span>
<span style="color:#5bc4bf">}</span>
</code></pre></div><p>至此就可以把前面寫的 <code>WebMvcConfig</code> 刪掉啦</p>
<p>至於沒找到 <code>WebMvcRegistrations</code> 介面的朋友，要不就是你 Spring Boot 版本太低，不然就只能改用 <code>WebMvcRegistrationsAdpater</code> 試試看了 (攤手)</p>

                    
                    <HR width="100%" id="EOF">
		    <p style="color:#777;">Last modified on 2019-09-19</p>
                    
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts" href="https://idontwannarock.github.io/tech_blog/2021/11/hugo_semi_auto_deploy/">
			Next<br>Hugo 半自動部署
                </a>
                
                
                
                <a class="older-posts" href="https://idontwannarock.github.io/tech_blog/2019/05/spring_security_rbac/">
			Previous<br>Spring Security 整合 RBAC
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                










            </div>
        </div>
    </div>


                    </div>
            </div><div id="single-column-footer">
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://amazingrise.net">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	This website by Howard Wang is licensed under a Creative Common Attribution-ShareAlike 4.0 International License.
	
</div>
            </div>
    
    <script src="https://idontwannarock.github.io/tech_blog/js/journal.js"></script>
    </body>
</html>
